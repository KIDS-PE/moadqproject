id
id
id<-unique(id$person_id)
id
for (i in id) {tt<-tt %>% filter(person_id!=i)}
system.time(for (i in id) {tt<-tt %>% filter(person_id!=i)})
id[1]
tt %>% filter(person_id==1122938)
df_only_des<-tt
for (i in id) {tt<-tt %>% filter(person_id!=i)}
df_only_des<-tt
rm(tt,id)
#1-2.only diuretic
tt<-df_all_desdiu
id<-tt %>% filter(drug_name=='desmopressin')
id<-unique(id$person_id)
for (i in id) {tt<-tt %>% filter(person_id!=i)}
df_only_diu<-tt
rm(tt,id)
#one drug
func_one_drug_use<-function(df_all_drug,drug_name){
df_all_drug$exposure<-ifelse(df_all_drug$drug_name==drug_name, 0, 1)
id<-unique(df_all_drug$person_id)
tt2<-data.frame()
for (i in id) {
tt<-df_all_drug %>% filter(person_id==i)
if (nrow(tt)>=2) {
for (j in 2:nrow(tt)) {
if (tt$drug_exposure_start_date[j]<=tt$drug_exposure_end_date[j-1]) {
tt$exposure[j]<-tt$exposure[j-1]+tt$exposure[j]
tt$exposure[j-1]<-tt$exposure[j-1]+tt$exposure[j]}}}
tt2<-bind_rows(tt2,tt)
}
tt2<-tt2 %>% filter(exposure==0) %>% select(!exposure)
return(tt2)
}
#concomitant drug
func_concomitant_drug_use<-function(df_all_drug1,df_all_drug2,df_one_drug1,df_one_drug2){
df_all_drug<-bind_rows(df_all_drug1,df_all_drug2)
tt<-bind_rows(df_all_drug,df_one_drug1,df_one_drug2)
tt<-tt %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date)
tt$dupli<-duplicated(tt)
for (i in 2:nrow(tt)) {if (tt$dupli[i]==TRUE) {tt$dupli[i-1]<-TRUE}}
df_concomitant<-tt %>% filter(dupli==FALSE) %>% select(!dupli)
return(df_concomitant)
}
#concomitant drug use date
func_concomitant_date<-function(df_concomitant_drugs,drug_name1,drug_name2) {
tt<-df_concomitant_drugs %>% select(person_id,gender_concept_id,age_at_first_exposure,bins1,hoi_list_date,
drug_exposure_start_date,drug_exposure_end_date,event_date,
drug_name,drug_class,ingredient,drug_type)
id<-unique(df_concomitant_drugs$person_id)
df_concomitant_date<-data.frame()
for (i in id) {
tt2<-tt %>% filter(person_id==i)
tt_durg1<-tt2 %>% filter(drug_name==drug_name1)
tt_durg2<-tt2 %>% filter(drug_name==drug_name2)
for (j in 1:nrow(tt_durg1)) {
for (k in 1:nrow(tt_durg2)) {
tt3<-data.frame(person_id=c(i),
use_exposure_start_date=max(tt_durg1$drug_exposure_start_date[j],tt_durg2$drug_exposure_start_date[k]),
use_exposure_end_date=min(tt_durg1$drug_exposure_end_date[j],tt_durg2$drug_exposure_end_date[k]),
drug1_name=c(tt_durg1$drug_name[j]), drug1_type=c(tt_durg1$drug_type[j]),
drug2_name=c(tt_durg2$drug_name[k]),drug2_class=c(tt_durg2$drug_class[k]),drug2_ingredient=c(tt_durg2$ingredient[k]))
df_concomitant_date<-bind_rows(df_concomitant_date,tt3)}}}
df_concomitant_date<-df_concomitant_date %>% filter(use_exposure_end_date>=use_exposure_start_date)
}
#1.desmopressin + diuretic
#desmopressin use
dat<-df_all_desdiu %>% arrange(person_id,drug_exposure_start_date)
df_one_des<-one_drug_use(dat,'desmopressin')
#1.desmopressin + diuretic
#desmopressin use
dat<-df_all_desdiu %>% arrange(person_id,drug_exposure_start_date)
df_one_des<-func_one_drug_use(dat,'desmopressin')
system.time(df_one_des<-func_one_drug_use(dat,'desmopressin'))
system.time(df_one_des<-func_one_drug_use(dat,'desmopressin'))
rm(dat)
#diuretic use
dat<-df_all_desdiu %>% arrange(person_id,drug_exposure_start_date)
system.time(df_one_diu<-func_one_drug_use(dat,'diuretic'))
rm(dat)
#concomitant use / use date
df_desdiu<-func_concomitant_drug_use(df_all_des,df_all_diu,df_one_des,df_one_diu)
#concomitant use / use date
system.time(df_desdiu<-func_concomitant_drug_use(df_all_des,df_all_diu,df_one_des,df_one_diu))
system.time(df_desdiu_date<-func_concomitant_date(df_desdiu,'desmopressin','diuretic'))
system.time(df_desdiu_date<-func_concomitant_date(df_desdiu,'desmopressin','diuretic'))
#concomitant drug use date
func_concomitant_date<-function(df_concomitant_drugs,drug_name1,drug_name2) {
tt<-df_concomitant_drugs %>% select(person_id,drug_exposure_start_date,drug_exposure_end_date,drug_name,drug_class,ingredient,drug_type)
id<-unique(df_concomitant_drugs$person_id)
df_concomitant_date<-data.frame()
for (i in id) {
tt2<-tt %>% filter(person_id==i)
tt_durg1<-tt2 %>% filter(drug_name==drug_name1)
tt_durg2<-tt2 %>% filter(drug_name==drug_name2)
for (j in 1:nrow(tt_durg1)) {
for (k in 1:nrow(tt_durg2)) {
tt3<-data.frame(person_id=c(i),
use_exposure_start_date=max(tt_durg1$drug_exposure_start_date[j],tt_durg2$drug_exposure_start_date[k]),
use_exposure_end_date=min(tt_durg1$drug_exposure_end_date[j],tt_durg2$drug_exposure_end_date[k]),
drug1_name=c(tt_durg1$drug_name[j]),drug1_type=c(tt_durg1$drug_type[j]),
drug2_name=c(tt_durg2$drug_name[k]),drug2_class=c(tt_durg2$drug_class[k]),drug2_ingredient=c(tt_durg2$ingredient[k]))
df_concomitant_date<-bind_rows(df_concomitant_date,tt3)}}}
df_concomitant_date<-df_concomitant_date %>% filter(use_exposure_end_date>=use_exposure_start_date)
}
#concomitant drug use date
func_concomitant_date<-function(df_concomitant_drugs,drug_name1,drug_name2) {
tt<-df_concomitant_drugs %>% select(person_id,drug_exposure_start_date,drug_exposure_end_date,drug_name,drug_class,ingredient,drug_type)
id<-unique(df_concomitant_drugs$person_id)
df_concomitant_date<-data.frame()
for (i in id) {
tt2<-tt %>% filter(person_id==i)
tt_durg1<-tt2 %>% filter(drug_name==drug_name1)
tt_durg2<-tt2 %>% filter(drug_name==drug_name2)
for (j in 1:nrow(tt_durg1)) {
for (k in 1:nrow(tt_durg2)) {
tt3<-data.frame(person_id=c(i),
use_exposure_start_date=max(tt_durg1$drug_exposure_start_date[j],tt_durg2$drug_exposure_start_date[k]),
use_exposure_end_date=min(tt_durg1$drug_exposure_end_date[j],tt_durg2$drug_exposure_end_date[k]),
drug1_name=c(tt_durg1$drug_name[j]),drug1_type=c(tt_durg1$drug_type[j]),
drug2_name=c(tt_durg2$drug_name[k]),drug2_class=c(tt_durg2$drug_class[k]),drug2_ingredient=c(tt_durg2$ingredient[k]))
df_concomitant_date<-bind_rows(df_concomitant_date,tt3)}}}
df_concomitant_date<-df_concomitant_date %>% filter(use_exposure_end_date>=use_exposure_start_date)
}
df_desdiu_date<-func_concomitant_date(df_desdiu,'desmopressin','diuretic')
#concomitant drug use date
func_concomitant_date<-function(df_concomitant_drugs,drug_name1,drug_name2) {
tt<-df_concomitant_drugs %>% select(person_id,drug_exposure_start_date,drug_exposure_end_date,drug_name,drug_class,ingredient,drug_type)
id<-unique(df_concomitant_drugs$person_id)
df_concomitant_date<-data.frame()
for (i in id) {
tt2<-tt %>% filter(person_id==i)
tt_durg1<-tt2 %>% filter(drug_name==drug_name1)
tt_durg2<-tt2 %>% filter(drug_name==drug_name2)
for (j in 1:nrow(tt_durg1)) {
for (k in 1:nrow(tt_durg2)) {
tt3<-data.frame(person_id=c(i),
use_exposure_start_date=max(tt_durg1$drug_exposure_start_date[j],tt_durg2$drug_exposure_start_date[k]),
use_exposure_end_date=min(tt_durg1$drug_exposure_end_date[j],tt_durg2$drug_exposure_end_date[k]),
drug1_name=c(tt_durg1$drug_name[j]),drug1_type=c(tt_durg1$drug_type[j]),
drug2_name=c(tt_durg2$drug_name[k]),drug2_class=c(tt_durg2$drug_class[k]),drug2_ingredient=c(tt_durg2$ingredient[k]))
df_concomitant_date<-bind_rows(df_concomitant_date,tt3)}}}
df_concomitant_date<-df_concomitant_date %>% filter(use_exposure_end_date>=use_exposure_start_date)
}
tt<-df_desdiu %>% select(person_id,drug_exposure_start_date,drug_exposure_end_date,drug_name,drug_class,ingredient,drug_type)
tt
id<-unique(df_concomitant_drugs$person_id)
id<-unique(tt$person_id)
id
id<-unique(tt$person_id)
df_concomitant_date<-data.frame()
for (i in id) {
tt2<-tt %>% filter(person_id==i)
tt_durg1<-tt2 %>% filter(drug_name==drug_name1)
tt_durg2<-tt2 %>% filter(drug_name==drug_name2)
for (j in 1:nrow(tt_durg1)) {
for (k in 1:nrow(tt_durg2)) {
tt3<-data.frame(person_id=c(i),
use_exposure_start_date=max(tt_durg1$drug_exposure_start_date[j],tt_durg2$drug_exposure_start_date[k]),
use_exposure_end_date=min(tt_durg1$drug_exposure_end_date[j],tt_durg2$drug_exposure_end_date[k]),
drug1_name=c(tt_durg1$drug_name[j]),drug1_type=c(tt_durg1$drug_type[j]),
drug2_name=c(tt_durg2$drug_name[k]),drug2_class=c(tt_durg2$drug_class[k]),drug2_ingredient=c(tt_durg2$ingredient[k]))
df_concomitant_date<-bind_rows(df_concomitant_date,tt3)}}}
id
tt2<-tt %>% filter(person_id==31498)
tt2
tt_durg1<-tt2 %>% filter(drug_name=='desmopressin')
tt_durg1
tt_durg1<-tt2 %>% filter(drug_name=='desmopressin')
tt_durg1
tt2<-tt %>% filter(person_id==1863694)
tt_durg1<-tt2 %>% filter(drug_name=='desmopressin')
tt_durg1
tt2<-tt %>% filter(person_id==1800465)
tt_durg1<-tt2 %>% filter(drug_name=='desmopressin')
tt2
View(tt2)
View(tt)
tt2<-tt %>% filter(person_id==1887044)
tt_durg1<-tt2 %>% filter(drug_name=='desmopressin')
tt_durg1
View(df_desdiu)
df_all_drug<-bind_rows(df_all_des,df_all_diu)
df_all_drug
nrow(df_all_drug)
nrow(df_all_drug); nrow(df_all_des)+nrow(df_all_diu)
warnings(nrow(df_all_drug))
df_all_drug<-bind_rows(df_all_des,df_all_diu)
warnings(df_all_drug<-bind_rows(df_all_des,df_all_diu))
tt<-rbind(df_all_des,df_all_diu)
warnings(tt<-rbind(df_all_des,df_all_diu))
ncol(df_all_des)
ncol(df_all_diu)
df_all_drug<-bind_rows(df_all_des,df_all_diu)
tt<-bind_rows(df_all_drug,df_one_des,df_one_diu)
tt<-tt %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date)
tt$dupli<-duplicated(tt)
View(tt)
View(x2)
#all desmopressin + diuretic
df_all_desdiu<-x2
df_all_desdiu<-df_all_desdiu %>% arrange(person_id,drug_exposure_start_date)
df_all_desdiu<-df_all_desdiu %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date)
#all desmopressin + diuretic
df_all_desdiu<-x2
df_all_desdiu<-df_all_desdiu %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date)
View(df_all_desdiu)
tt<-df_all_desdiu
nrow(tt)
nrow(x2)
tt %>% filter(drug_name=='desmopressin'&drug_name=='diuretic')
tt2<-tt %>% filter(drug_name=='desmopressin'&drug_name=='diuretic')
nrow(tt2)
tt2<-tt %>% group_by(person_id) %>% filter(drug_name=='desmopressin'&drug_name=='diuretic')
nrow(tt2)
tt2<-tt %>% group_by(person_id) %>% filter(drug_name %in% c('desmopressin','diuretic'))
nrow(tt2)
tt<-bind_rows(df_all_desdiu,df_one_des,df_one_diu)
tt<-tt %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date)
tt$dupli<-duplicated(tt)
for (i in 2:nrow(tt)) {if (tt$dupli[i]==TRUE) {tt$dupli[i-1]<-TRUE}}
View(tt)
tt_2drug<-tt %>% filter(dupli==FALSE)
tt_2drug
View(tt_2drug)
tt %>% filter(person_id==)
tt %>% filter(person_id==3149)
ttt<-tt %>% filter(person_id==3149)
View(ttt)
ttt<-tt %>% filter(person_id==103074)
View(ttt)
ttt<-tt %>% filter(person_id==259687)
View(ttt)
View(ttt)
tt<-tt %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date,drug_exposure_end_date)
tt$dupli<-duplicated(tt)
tt<-bind_rows(df_all_desdiu,df_one_des,df_one_diu)
tt<-tt %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date,drug_exposure_end_date)
tt$dupli<-duplicated(tt)
for (i in 2:nrow(tt)) {if (tt$dupli[i]==TRUE) {tt$dupli[i-1]<-TRUE}}
tt_2drug<-tt %>% filter(dupli==FALSE)
View(ttt)
View(tt_2drug)
tt_2drug<-tt %>% filter(dupli==FALSE)
View(tt_2drug)
View(ttt)
View(tt)
ttt<-tt %>% filter(person_id==1885309)
View(ttt)
tt<-bind_rows(df_all_desdiu,df_only_des,df_only_diu)
tt<-tt %>% group_by(person_id) %>% arrange(person_id,drug_exposure_start_date,drug_exposure_end_date)
tt$dupli<-duplicated(tt)
for (i in 2:nrow(tt)) {if (tt$dupli[i]==TRUE) {tt$dupli[i-1]<-TRUE}}
tt_2drug<-tt %>% filter(dupli==FALSE)
View(tt_2drug)
ttt<-tt %>% filter(person_id==922607)
View(ttt)
ttt<-tt %>% filter(person_id==1893133)
View(ttt)
max(tt$person_id)
which(tt %>% filter(person_id==1887044))
tt %>% which(person_id==1887044)
which(tt$person_id==1887044)
tt[,which(tt$person_id==1887044)]
tt$drug_name[,which(tt$person_id==1887044)]
tt2<-tt$drug_name[,which(tt$person_id==1887044)]
tt2
rm(tt2)
tt2<-tt$drug_name[,which(tt$person_id==1887044)]
tt2
tt2<-tt[,which(tt$person_id==1887044)]
tt2<-tt[which(tt$person_id==1887044)]
tt[3]
tt[,3]
tt2<-tt$drug_name[which(tt$person_id==1887044),]
tt[3,]
tt$drug_name[3,]
tt[3,] %>% select(drug_name)
tt2<-tt$drug_name[which(tt$person_id==1887044),] %>% select(drug_name)
tt2<-tt[which(tt$person_id==1887044),] %>% select(drug_name)
tt2
tt2<-tt[which(tt$person_id==1887044),] %>% select(person_id,drug_name)
tt2
table(tt$drug_name)
tt %>% table(drug_name)
table(tt$person_id,tt$drug_name)
tt2<-table(tt$person_id,tt$drug_name)
str(tt2)
View(tt2)
tt2<-as.data.frame(table(tt$person_id,tt$drug_name))
str(tt2)
View(tt2)
View(tt2)
names(tt2)<-c('person_id','drug_name','scrp_num')
View(tt2)
tt2 %>% arrange(person_id)
tt2<-tt2 %>% arrange(person_id)
View(tt2)
id<-tt2 %>% filter(scrp_num==0)
View(id)
id<-tt2 %>% filter(scrp_num==0) %>% select(person_id)
View(id)
id<-c(tt2 %>% filter(scrp_num==0) %>% select(person_id))
View(id)
id
tt3<-tt2 %>% filter(person_id!=id)
View(tt3)
tt3<-tt2 %>% filter(person_id %in% id)
View(tt3)
id<-c(tt2 %>% filter(scrp_num==0) %>% select(person_id))
tt3<-tt2 %>% filter(person_id %in% id)
View(tt3)
View(tt2)
tt3<-tt2 %>% filter(person_id %in% c(id))
View(tt3)
id<-c(tt2 %>% filter(scrp_num==0) %>% select(person_id))
id
View(tt2)
tt2<-table(tt$person_id,tt$drug_name)
View(tt2)
tt3<-tt2 %>% filter(person_id %in% c(id))
id<-c(unique(tt2 %>% filter(scrp_num==0) %>% select(person_id)))
id<-c(tt2 %>% filter(scrp_num==0) %>% select(person_id))
tt2<-as.data.frame(table(tt$person_id,tt$drug_name))
names(tt2)<-c('person_id','drug_name','scrp_num')
tt2<-tt2 %>% arrange(person_id)
id<-c(tt2 %>% filter(scrp_num==0) %>% select(person_id))
View(id)
id<-c(tt2 %>% filter(scrp_num==0) %>% select(person_id)); id<-unique(id)
tt3<-tt2 %>% filter(person_id %in% c(id))
View(tt3)
tt3<-tt2 %>% filter(scrp_num==0)
View(tt3)
rm(tt3)
tt3<-data.frame()
for (i in 1:nrow(tt2)) {
if (tt2$person_id[i] %in% id) { } else {tt3<-bind_rows(tt3,tt2[i])}
}
tt3<-data.frame()
View(tt3)
for (i in 1:nrow(tt2)) {
if (tt2$person_id[i,] %in% id) { } else {tt3<-bind_rows(tt3,tt2[i,])}
}
for (i in 1:nrow(tt2)) {
if (tt2$person_id[i,] %in% c(id)) { } else {tt3<-bind_rows(tt3,tt2[i,])}
}
tt2$person_id[1,]
tt2$person_id[1]
for (i in 1:nrow(tt2)) {
if (tt2$person_id[i] %in% id) { } else {tt3<-bind_rows(tt3,tt2[i,])}
}
for (i in 1:nrow(tt2)) {
if (tt2$person_id[i] %in% id) { } else {tt3<-bind_rows(tt3,tt2[i,])}
}
tt2$person_id[1]
tt2[1,]
tt2[1]
View(tt2)
tt2<-as.data.frame(table(tt$person_id,tt$drug_name))
names(tt2)<-c('person_id','drug_name','presc_num')
tt2<-tt2 %>% arrange(person_id)
View(tt2)
tt2$era<-0
View(tt2)
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$presc_num[i-1]<-0} else {tt2$presc_num[i-1]<-1}}
View(tt2)
tt2<-as.data.frame(table(tt$person_id,tt$drug_name))
names(tt2)<-c('person_id','drug_name','presc_num')
tt2<-tt2 %>% arrange(person_id)
tt2$era<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
View(tt2)
tt2 %>% filter(person_id==1885309)
tt2$era<-0
View(tt2)
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-1} else {tt2$era[i-1]<-0}}
View(tt2)
tt2 %>% filter(person_id==1885309)
tt2$era<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
View(tt2)
tt2 %>% filter(person_id==1885309)
tt2$era<-0; era$sum<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
View(tt2)
tt2$era<-0; tt2$era_sum<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
View(tt2)
seq(1,nrow(tt2),2)
seq(2,nrow(tt2),2)
for (i in seq(2,nrow(tt2),2)) {tt$era_sum<-tt2$era[i]+tt2$era[i-1]}
View(tt2)
for (i in seq(2,nrow(tt2),2)) {tt2$era_sum<-tt2$era[i]+tt2$era[i-1]}
View(tt2)
tt2 %>% filter(person_id==1885309)
tt2$era<-0; tt2$era_sum<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
tt2$era<-0; tt2$era_sum<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
for (i in seq(2,nrow(tt2),2)) {tt2$era_sum[i]<-tt2$era[i]+tt2$era[i+1];tt2$era_sum[i-1]<-tt2$era[i]+tt2$era[i-1]}
View(tt2)
tt2 %>% filter(person_id==1885309)
tt2$era<-0; tt2$era_sum<-0
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
for (i in seq(2,nrow(tt2),2)) {tt2$era_sum[i]<-tt2$era[i]+tt2$era[i-1]; tt2$era_sum[i-1]<-tt2$era[i]+tt2$era[i-1]}
View(tt2)
tt2 %>% filter(person_id==1885309)
View(tt)
tt<-df_all_desdiu
tt2<-table(tt$person_id,tt$drug_name)
tt2<-as.data.frame(table(tt$person_id,tt$drug_name))
View(tt)
View(tt2)
names(tt2)<-c('person_id','drug_name','presc_num')
tt2<-tt2 %>% arrange(person_id)
View(tt2)
tt2<-tt2 %>% arrange(person_id)
tt2$era<-0; tt2$era_sum<-0
View(tt2)
for (i in 2:nrow(tt2)) {if (tt2$presc_num[i]==0) {tt2$era[i-1]<-0} else {tt2$era[i-1]<-1}}
for (i in seq(2,nrow(tt2),2)) {tt2$era_sum[i]<-tt2$era[i]+tt2$era[i-1]; tt2$era_sum[i-1]<-tt2$era[i]+tt2$era[i-1]}
View(tt2)
tt2 %>% filter(era_sum==2)
tt2 %>% filter(era_sum==2) %>% select(person_id)
unique(tt2 %>% filter(era_sum==2) %>% select(person_id))
id<-unique(tt2 %>% filter(era_sum==2) %>% select(person_id))
id
id<-c(unique(tt2 %>% filter(era_sum==2) %>% select(person_id)))
id
id<-as.vector(unique(tt2 %>% filter(era_sum==2) %>% select(person_id)))
id
tt %>% filter(person_id==id)
id<-unique(tt2 %>% filter(era_sum==2) %>% select(person_id))
id
id<-unique(tt2 %>% filter(era_sum==2) %>% select(person_id))
id
id[]
id[]
id
id[[]]
id[[1]]
id<-id[[1]]
id
tt %>% filter(person_id==id)
tt %>% filter(person_id %in% id)
id
tt3<-tt %>% filter(person_id %in% id)
df_desdiu<-tt %>% filter(person_id %in% id)
View(df_desdiu)
tt %>% filter(person_id %in% 1885247)
tt3<-tt %>% filter(person_id %in% 1885247)
View(tt3)
tt<-df_all_desdiu
tt3<-tt %>% filter(person_id %in% 1885247)
View(tt3)
tt3<-tt %>% filter(person_id %in% 1885247)
View(tt3)
View(tt3)
table(tt3$drug_name)
tt2 %>% filter(person_id %in% 1885247)
View(tt2)
tt<-df_all_desdiu
tt2<-as.data.frame(table(tt$person_id,tt$drug_name))
names(tt2)<-c('person_id','drug_name','presc_num')
tt2<-tt2 %>% arrange(person_id)
tt2$era<-0; tt2$era_sum<-0
for (i in seq(1,nrow(tt2),2)) {if (tt2$presc_num[i]==0) {tt2$era[i]<-0} else {tt2$era[i]<-1}}
for (i in seq(2,nrow(tt2),2)) {if (tt2$presc_num[i]==0) {tt2$era[i]<-0} else {tt2$era[i]<-1}}
for (i in seq(2,nrow(tt2),2)) {tt2$era_sum[i]<-tt2$era[i]+tt2$era[i-1]; tt2$era_sum[i-1]<-tt2$era[i]+tt2$era[i-1]}
View(tt2)
id<-unique(tt2 %>% filter(era_sum==2) %>% select(person_id))
id
id<-id[[1]]
id
df_desdiu<-tt %>% filter(person_id %in% id)
tt3<-tt %>% filter(person_id %in% 1885309)
tt %>% filter(person_id %in% 1885309)
tt3<-tt %>% filter(person_id %in% 1885309)
View(tt3)
id
1885309
tt3<-tt %>% filter(person_id %in% 1885309)
View(tt3)
tt3<-tt %>% filter(person_id %in% 1887044)
View(tt3)
df_desdiu<-tt %>% filter(person_id %in% id)
View(df_desdiu)
#concomitant drug use date
func_concomitant_date<-function(df_concomitant_drugs,drug_name1,drug_name2) {
tt<-df_concomitant_drugs %>% select(person_id,drug_exposure_start_date,drug_exposure_end_date,drug_name,drug_class,ingredient,drug_type)
id<-unique(tt$person_id)
df_concomitant_date<-data.frame()
for (i in id) {
tt2<-tt %>% filter(person_id==i)
tt_durg1<-tt2 %>% filter(drug_name==drug_name1)
tt_durg2<-tt2 %>% filter(drug_name==drug_name2)
for (j in 1:nrow(tt_durg1)) {
for (k in 1:nrow(tt_durg2)) {
tt3<-data.frame(person_id=c(i),
use_exposure_start_date=max(tt_durg1$drug_exposure_start_date[j],tt_durg2$drug_exposure_start_date[k]),
use_exposure_end_date=min(tt_durg1$drug_exposure_end_date[j],tt_durg2$drug_exposure_end_date[k]),
drug1_name=c(tt_durg1$drug_name[j]),drug1_type=c(tt_durg1$drug_type[j]),
drug2_name=c(tt_durg2$drug_name[k]),drug2_class=c(tt_durg2$drug_class[k]),drug2_ingredient=c(tt_durg2$ingredient[k]))
df_concomitant_date<-bind_rows(df_concomitant_date,tt3)}}}
df_concomitant_date<-df_concomitant_date %>% filter(use_exposure_end_date>=use_exposure_start_date)
}
df_desdiu
df_desdiu_date<-func_concomitant_date(df_desdiu,'desmopressin','diuretic')
df_desdiu_date<-func_concomitant_date(df_desdiu,'desmopressin','diuretic')
df_desdiu_date
